// Generated by CoffeeScript 1.7.1
(function() {
  var chart, draw, drawChart, submit, textarea, validate;

  textarea = null;

  chart = null;

  submit = null;

  $(document).ready(function() {
    textarea = $("#formula");
    chart = $("#chart");
    submit = $("#submit");
    chart.css("width", $(document).width() - 340);
    chart.css("height", $(document).height - 90);
    textarea.on("keyup", validate);
    return submit.on("click", draw);
  });

  draw = function() {
    if (!validate()) {
      return;
    }
    chart.html("<div class=\"progress progress-striped active\">\n  <div class=\"progress-bar\"  role=\"progressbar\" style=\"width: 100%\"></div>\n</div>");
    submit.button('loading');
    return $.ajax({
      type: "POST",
      url: "/data",
      data: {
        formula: textarea.val()
      },
      success: function(data) {
        chart.empty();
        submit.button('reset');
        return drawChart(data);
      },
      error: function(data) {
        chart.empty();
        submit.button('reset');
        return bootbox.alert("/data POST error");
      }
    });
  };

  drawChart = function(data) {
    return $.jqplot("chart", [data], {
      axes: {
        xaxis: {
          label: "X",
          labelRenderer: $.jqplot.CanvasAxisLabelRenderer
        },
        yaxis: {
          label: 'Y',
          labelRenderer: $.jqplot.CanvasAxisLabelRenderer
        }
      },
      series: [
        {
          showMarker: false
        }
      ]
    });
  };

  validate = function() {
    var message, parent, valid;
    valid = true;
    parent = textarea.parent();
    parent.removeClass("has-error");
    parent.children(".alert").remove();
    if (!textarea.val() || textarea.val() === "") {
      valid = false;
      message = "Поле не должно быть пустым";
    }
    if (!/^(x|\d|\+|-|\*|\/|\(|\)|\s|Math\.\w+|,)*$/.test(textarea.val())) {
      valid = false;
      message = "Неправильная формула. Прочтите документацию.";
    }
    if (!valid) {
      parent.addClass("has-error");
      parent.append("<div class=\"alert alert-danger\">" + message + "</div>");
    }
    return valid;
  };

}).call(this);
